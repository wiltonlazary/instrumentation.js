{"version":3,"sources":["../src/binder.ts"],"names":[],"mappings":"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","file":"binder.js","sourcesContent":["import { Instrumentation, PropertyCallType, valueFromPath, ABORT_ACTION } from './instrumentation'\n\nexport interface BinderDispatchCarrier {\n    value: any\n    oldValue: any\n    abort?: boolean\n    preventDefault?: boolean\n    onFinished?: (value: any, oldValue: any, result: any) => void\n}\n\nexport interface BinderDispatchDetail {\n    binder: Binder\n    carrier: BinderDispatchCarrier\n    content: {\n        value: any\n        oldValue: any\n        slicedValue: any\n        slicedOldValue: any\n        operation: DispatchOperation\n        path: Array<any>\n        match: DispatchMatch\n        changed: boolean\n    }\n}\n\nlet _currentBinderDispatchDetail: BinderDispatchDetail = null\nlet _bypassNextBinderDispatch = false\nlet _abortNextBinderDispatch = false\n\nexport type BinderConsumerType = (value: any, detai: BinderDispatchDetail) => any | any\nexport type DispatchOperation = 'init' | 'call' | 'delete' | 'set' | 'push' | 'pop' | 'unshift' | 'shift' | 'clear'\nexport type DispatchMatch = '<' | '=' | '>'\n\nexport function currentBinderDispatchDetail(): any {\n    return _currentBinderDispatchDetail\n}\n\nexport function bypassNextBinderDispatch() {\n    _bypassNextBinderDispatch = true\n}\n\nexport function abortNextBinderDispatch() {\n    _abortNextBinderDispatch = true\n}\n\nexport function checkAbortNextBinderDispatch(): boolean {\n    return _abortNextBinderDispatch\n}\n\nexport function cleanAbortNextBinderDispatch() {\n    _abortNextBinderDispatch = false\n}\n\nexport class Binder {\n    _disposed = false\n    consumerInstrumentation: Instrumentation = null\n\n    constructor(\n        public readonly producerInstrumentation: Instrumentation,\n        public readonly producer: any,\n        public readonly producerPropertyKey: any,\n        public readonly producerPropertyPath: Array<any>,\n        public readonly producerPropertyPathRegExp: RegExp,\n        public readonly producerPropertyCallTypeDetail: [PropertyCallType, any],\n        public readonly consumer: BinderConsumerType,\n        public readonly consumerPropertyKey: any,\n        public readonly consumerPropertyCallType: PropertyCallType,\n        public deep: boolean,\n        public active: boolean\n    ) {\n    }\n\n    get producerOwner(): any {\n        return this.producerInstrumentation.owner\n    }\n\n    get consumerOwner(): any {\n        return !!this.consumerInstrumentation ? this.consumerInstrumentation.owner : null\n    }\n\n    get disposed(): boolean {\n        return this._disposed\n    }\n\n    dispatch(carrier: BinderDispatchCarrier, operation: DispatchOperation, path: Array<any>, match: DispatchMatch): any {\n        let result = undefined\n\n        if (_abortNextBinderDispatch) {\n            _abortNextBinderDispatch = false\n            _bypassNextBinderDispatch = false\n            result = ABORT_ACTION\n        } else if (_bypassNextBinderDispatch) {\n            _abortNextBinderDispatch = false\n            _bypassNextBinderDispatch = false\n        } else {\n            const value = carrier.value\n            const oldValue = carrier.oldValue\n            let slicedValue = value\n            let slicedOldValue = oldValue\n\n            if (match === '<') {\n                const templatePath = this.producerPropertyPath.slice(path.length)\n                const basePath = path.slice(1)\n                slicedValue = valueFromPath(value, templatePath, basePath)\n                slicedOldValue = valueFromPath(oldValue, templatePath, basePath)\n            } else if (match === '>') {\n                slicedOldValue = valueFromPath(this.producerOwner, this.producerPropertyPath, path)\n                \n                //?is not possible to do a deep object clone and replace parts without compromises the immutability and relations?\n                slicedValue = slicedOldValue \n            }\n\n            const dispatchDetail: BinderDispatchDetail = {\n                binder: this,\n                carrier: carrier,\n                content: {\n                    value: value,\n                    oldValue: oldValue,\n                    slicedValue: slicedValue,\n                    slicedOldValue: slicedOldValue,\n                    operation: operation,\n                    path: path,\n                    match: match,\n                    changed: value != oldValue\n                }\n            }\n\n            const savedBinderBinderDispatchDetail = _currentBinderDispatchDetail\n            _currentBinderDispatchDetail = dispatchDetail\n\n            try {\n                if (this.consumerPropertyCallType === 'none') {\n                    result = this.consumer(slicedValue, dispatchDetail)\n                } else if (this.consumerPropertyCallType === 'function') {\n                    if (this.producerPropertyCallTypeDetail[0] === 'function') {\n                        result = this.consumer[this.consumerPropertyKey](...slicedValue)\n                    } else {\n                        result = this.consumer[this.consumerPropertyKey](slicedValue)\n                    }\n                } else {\n                    if (this.producerPropertyCallTypeDetail[0] === 'function') {\n                        this.consumer[this.consumerPropertyKey] = slicedValue instanceof Array ? (slicedValue.length > 0 ? slicedValue[0] : undefined) : slicedValue\n                    } else {\n                        this.consumer[this.consumerPropertyKey] = slicedValue\n                    }\n                }\n            } finally {\n                _currentBinderDispatchDetail = savedBinderBinderDispatchDetail\n            }\n        }\n\n        return result\n    }\n\n    dispose() {\n        if (!this._disposed) {\n            this._disposed = true\n            this.producerInstrumentation.unbindOut(this)\n\n            if (this.consumerInstrumentation !== null) {\n                this.consumerInstrumentation.unbindIn(this)\n            }\n        }\n    }\n}"]}