{"version":3,"sources":["../src/binder.ts"],"names":[],"mappings":"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","file":"binder.js","sourcesContent":["import { Instrumentation, PropertyCallType, valueFromPath } from './instrumentation'\n\nexport interface BinderDispatchDetail {\n    binder: Binder\n    content: {\n        dispatchValue: any\n        dispatchOldValue: any\n        value: any\n        oldValue: any\n        operation: DispatchOperation\n        path: Array<string>\n        match: DispatchMatch\n    }\n}\n\nlet _currentBinderDispatchDetail: BinderDispatchDetail = null\nlet _bypassBinderDispatch = false\n\nexport type BinderConsumerType = (value: any, detai: BinderDispatchDetail) => any | any\nexport type DispatchOperation = 'call' | 'delete' | 'set'\nexport type DispatchMatch = '<' | '=' | '>'\n\nexport function currentBinderDispatchDetail(): any {\n    return _currentBinderDispatchDetail\n}\n\nexport function bypassBinderDispatch() {\n    _bypassBinderDispatch = true\n}\n\nexport class Binder {\n    _disposed = false\n    inInstrumentation: Instrumentation = null\n\n    constructor(\n        public readonly outInstrumentation: Instrumentation,\n        public readonly producer: any,\n        public readonly producerPropertyKey: string,\n        public readonly producerPropertyKeyPath: string,\n        public readonly producerPropertyKeyPathParts: Array<string>,\n        public readonly producerPropertyKeyPathRegExp: RegExp,\n        public readonly producerPropertyCallTypeDetail: [PropertyCallType, any],\n        public readonly consumer: BinderConsumerType,\n        public readonly consumerPropertyKey: string,\n        public readonly consumerPropertyCallType: PropertyCallType,\n        public deep: boolean,\n        public active: boolean\n    ) {\n    }\n\n    get outOwner(): any {\n        return this.outInstrumentation.owner\n    }\n\n    get inOwner(): any {\n        return !!this.inInstrumentation ? this.inInstrumentation.owner : null\n    }\n\n    get disposed(): boolean {\n        return this._disposed\n    }\n\n    dispatch(value: any, oldValue: any, operation: DispatchOperation, path: Array<string>, match: DispatchMatch): any {\n        let result = undefined\n\n        if (_bypassBinderDispatch) {\n            _bypassBinderDispatch = false\n        } else {\n            let valueLocal = value\n            let oldValueLocal = oldValue\n\n            if (match === '<') {\n                const fromPath = this.producerPropertyKeyPathParts.slice(path.length)\n                valueLocal = valueFromPath(value, fromPath)\n                oldValueLocal = valueFromPath(oldValue, fromPath)\n            } else if (match === '>') {\n                valueLocal = valueFromPath(this.outOwner[this.producerPropertyKey], this.producerPropertyKeyPathParts.slice(1))\n                oldValueLocal = undefined\n            }\n\n            const dispatchDetail: BinderDispatchDetail = {\n                binder: this,\n                content: {\n                    dispatchValue: value,\n                    dispatchOldValue: oldValue,\n                    value: valueLocal,\n                    oldValue: oldValueLocal,\n                    operation: operation,\n                    path: path,\n                    match: match\n                }\n            }\n\n            const savedBinderBinderDispatchDetail = _currentBinderDispatchDetail\n            _currentBinderDispatchDetail = dispatchDetail\n\n            try {\n                if (this.consumerPropertyCallType === 'none') {\n                    result = this.consumer(valueLocal, dispatchDetail)\n                } else if (this.consumerPropertyCallType === 'function') {\n                    if (this.producerPropertyCallTypeDetail[0] === 'function') {\n                        result = this.consumer[this.consumerPropertyKey](...valueLocal)\n                    } else {\n                        result = this.consumer[this.consumerPropertyKey](valueLocal)\n                    }\n                } else {\n                    if (this.producerPropertyCallTypeDetail[0] === 'function') {\n                        this.consumer[this.consumerPropertyKey] = valueLocal instanceof Array ? (valueLocal.length > 0 ? valueLocal[0] : undefined) : valueLocal\n                    } else {\n                        this.consumer[this.consumerPropertyKey] = valueLocal\n                    }\n                }\n            } finally {\n                _currentBinderDispatchDetail = savedBinderBinderDispatchDetail\n            }\n        }\n\n        return result\n    }\n\n    dispose() {\n        if (!this._disposed) {\n            this._disposed = true\n            this.outInstrumentation.unbindOut(this)\n\n            if (this.inInstrumentation !== null) {\n                this.inInstrumentation.unbindIn(this)\n            }\n        }\n    }\n}"]}